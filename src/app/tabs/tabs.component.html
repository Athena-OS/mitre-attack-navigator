<div class="header-wrapper">
    <!-- banner -->
    <div *ngIf="hasFeature('header') && bannerContent" class="header">
        <div class="banner">
            <span class="bannerContent" role="alert" [innerHTML]="bannerContent"></span>
            <div class="bannerLinks">
                <a href="http://attack.mitre.org">MITRE ATT&CK&reg;</a>
            </div>
        </div>
    </div>

    <!-- help/changelog/theme -->
    <div class="header help-header">
        <div class="header-controls">
            <!-- theme selection -->
        </div>
        <div class="dropdown-container" *ngIf="showHelpDropDown && adjustedHeaderHeight >= 0">
            <button (click)="openDialog('help')">help</button>
            <button (click)="openDialog('changelog')">changelog</button>
        </div>
    </div>

    <!-- tabs -->
    <div class="tabs-container scroll">
        <nav mat-tab-nav-bar class="tabs" [tabPanel]="tabPanel" backgroundColor="undefined">
            <!-- open tabs -->
            <a
                *ngFor="let tab of layerTabs; let $i = index"
                mat-tab-link
                class="tab-title"
                [class.active]="activeTab === tab"
                (click)="handleTabClick(tab)"
                [active]="activeTab === tab">
                {{ tab.isDataTable ? tab.viewModel.name : tab.title }}
                <button mat-icon-button *ngIf="tab.isCloseable" (click)="closeTab(tab)" class="tab-close icon-button-scale-down">
                    <mat-icon>close</mat-icon>
                </button>
                <span
                    class="tab-enumerator"
                    *ngIf="activeTab.showScoreVariables && tab.isDataTable && (!domain || tab.domain === domain) && isAlphabetical(indexToChar($i))">
                    {{ indexToChar($i) }}
                </span>
            </a>
            <!-- create a new tab -->
            <a mat-tab-link class="add-tab" *ngIf="hasFeature('tabs') && layerTabs.length < 12" (click)="newBlankTab()">
                <mat-icon>add</mat-icon>
            </a>
        </nav>
        <mat-tab-nav-panel #tabPanel></mat-tab-nav-panel>
    </div>

    <div *ngIf="layerTabs.length == 0" class="new-tab">
        <!-- should never see this, but in case the config fails to load -->
        <button (click)="newBlankTab()">Start</button>
    </div>
</div>

<div class="tab-content">
<ng-template #safariWarning>
    <div class="safari-warning">
        <h3>WARNING</h3>
        <p>
            Weâ€™ve detected that you are using the Safari browser. As of Navigator version
            <b>4.3</b>
            , Safari versions 13 and below are not supported due to an unfixable freeze that can occur when selecting a layer tab.
        </p>
        <p>
            We recommend you use Chrome or Firefox instead. You can continue to use the Navigator in Safari (versions 13 and below), but you may lose
            work if the application freezes.
        </p>
        <button mat-button (click)="safariDialogRef.close()">Dismiss</button>
    </div>
</ng-template>

<ng-template #versionWarning let-data>
    <div class="version-warning">
        <div>
            <h3 mat-dialog-title>
                <u>WARNING:</u>
                Outdated Layer
            </h3>
            <mat-dialog-content>
                <p>
                    The uploaded layer version ({{ data.objVersion }}) does not match Navigator's layer version ({{ data.globalVersion }}). The layer
                    configuration may not be fully restored.
                </p>
                <p>View the latest Layer File Format specification and the changelog for more information:</p>
                <p>
                    <a (click)="openDialog('layers')">Layer File Format v{{ data.globalVersion }}</a>
                </p>
                <p>
                    <a (click)="openDialog('changelog')">Changelog</a>
                </p>
            </mat-dialog-content>
        </div>

        <button mat-button mat-dialog-close (click)="versionDialogRef.close()">Dismiss</button>
    </div>
</ng-template>

<!-- new tab template -->
<ng-template [ngIf]="activeTab && !activeTab.isDataTable">
    <div class="new-tab">
        <div class="flex items-center justify-between pb-4">
        <div class="description">
                <h2 class="text-lg font-semibold">Quick Actions</h2>
        </div>
            <div class="flex items-center gap-2">
                <!-- Sync button -->
                <div class="sync-button relative" (click)="$event.stopPropagation()">
                    <button type="button"
                            (click)="handleSyncClick()"
                            [disabled]="isSyncing"
                            class="flex items-center gap-2 rounded-md border border-transparent px-2 py-1 text-sm font-medium transition-colors"
                            [ngClass]="{
                              'text-gray-200 hover:bg-gray-800 hover:text-white disabled:text-gray-500 disabled:hover:bg-transparent': getActiveTheme() === 'dark',
                              'text-gray-600 hover:bg-gray-100 hover:text-gray-900 disabled:text-gray-400 disabled:hover:bg-transparent': getActiveTheme() === 'light',
                              'text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white disabled:text-gray-400 dark:disabled:text-gray-500 disabled:hover:bg-transparent dark:disabled:hover:bg-transparent': getActiveTheme() === 'system'
                            }"
                            [title]="isSyncing ? 'Syncing offline content...' : 'Sync content for offline viewing'">
                        <span class="inline-flex items-center gap-1">
                            <!-- Sync icon -->
                            <svg *ngIf="!isSyncing" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                                 [ngClass]="{
                                   'fill-gray-200': getActiveTheme() === 'dark',
                                   'fill-gray-500': getActiveTheme() === 'light',
                                   'fill-gray-500 dark:fill-gray-200': getActiveTheme() === 'system'
                                 }" viewBox="0 0 24 24">
                                <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                            </svg>
                            <!-- Loading spinner -->
                            <svg *ngIf="isSyncing" class="animate-spin h-5 w-5"
                                 [ngClass]="{
                                   'fill-gray-200': getActiveTheme() === 'dark',
                                   'fill-gray-500': getActiveTheme() === 'light',
                                   'fill-gray-500 dark:fill-gray-200': getActiveTheme() === 'system'
                                 }" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>{{ isSyncing ? 'Syncing...' : 'Sync' }}</span>
                        </span>
                    </button>
                    
                    <!-- Sync progress tooltip -->
                    <div *ngIf="isSyncing && syncProgress" class="absolute top-full right-0 z-50 mt-2 w-64 origin-top-right rounded-md border p-3 shadow-lg"
                         [ngClass]="{
                           'border-gray-700 bg-gray-900 text-gray-200': getActiveTheme() === 'dark',
                           'border-gray-200 bg-white text-gray-700': getActiveTheme() === 'light',
                           'border-gray-200 bg-white text-gray-700 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-200': getActiveTheme() === 'system'
                         }">
                        <div class="text-sm font-medium mb-2">Sync Progress</div>
                        <div class="text-xs mb-2">{{ syncProgress.completed }} / {{ syncProgress.total }} items</div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-2">
                            <div class="bg-emerald-500 h-2 rounded-full transition-all duration-300" 
                                 [style.width.%]="(syncProgress.completed / syncProgress.total) * 100"></div>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ syncProgress.current_item }}</div>
                    </div>
                </div>
                
            <div class="theme-button relative" (click)="$event.stopPropagation()">
                <button type="button"
                        (click)="toggleThemeMenu($event)"
                        class="flex items-center gap-2 rounded-md border border-transparent px-2 py-1 text-sm font-medium transition-colors"
                        [ngClass]="
                          getActiveTheme()==='dark' ? 'text-gray-200 hover:bg-gray-800 hover:text-white' :
                          getActiveTheme()==='light' ? 'text-gray-600 hover:bg-gray-100 hover:text-gray-900' :
                          'text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white'
                        "
                        [attr.aria-expanded]="themeMenuOpen"
                        [title]="'Theme: ' + getThemeLabel()">
                    <span class="inline-flex items-center gap-1">
                        <!-- Icon changes with theme -->
                        <svg *ngIf="getActiveTheme() === 'light'" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                             [ngClass]="getActiveTheme()==='dark' ? 'fill-gray-200' : getActiveTheme()==='system' ? 'fill-gray-500 dark:fill-gray-200' : 'fill-gray-500'" viewBox="0 0 24 24">
                            <path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm10.45 12.73l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM12 4V1h-1v3h1zm0 19v-3h-1v3h1zm8-8h3v-1h-3v1zM1 12H4v-1H1v1zm15.24-7.16l1.42 1.42 1.79-1.8-1.41-1.41-1.8 1.79zM4.22 18.36l1.8-1.79-1.42-1.42-1.79 1.8 1.41 1.41zM12 6a6 6 0 100 12 6 6 0 000-12z"/>
                        </svg>
                        <svg *ngIf="getActiveTheme() === 'dark'" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                             [ngClass]="getActiveTheme()==='dark' ? 'fill-gray-200' : getActiveTheme()==='system' ? 'fill-gray-500 dark:fill-gray-200' : 'fill-gray-500'" viewBox="0 0 24 24">
                            <path d="M12 2a9.93 9.93 0 00-7.07 2.93A10 10 0 1012 2zm0 18a8 8 0 118-8 8 8 0 01-8 8z"/>
                        </svg>
                        <svg *ngIf="getActiveTheme() === 'system'" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                             [ngClass]="'fill-gray-500 dark:fill-gray-200'" viewBox="0 0 24 24">
                            <path d="M21 3H3a2 2 0 00-2 2v11a2 2 0 002 2h7l-1 2h6l-1-2h7a2 2 0 002-2V5a2 2 0 00-2-2zm0 13H3V5h18v11z"/>
                        </svg>
                        <span>{{ getThemeLabel() }}</span>
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1"
                         [ngClass]="getActiveTheme()==='dark' ? 'fill-gray-300' : getActiveTheme()==='system' ? 'fill-gray-500 dark:fill-gray-300' : 'fill-gray-500'" viewBox="0 0 20 20"><path d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"/></svg>
                </button>

                <!-- Dropdown menu -->
                <div *ngIf="themeMenuOpen" class="absolute right-0 z-50 mt-2 w-44 origin-top-right rounded-md border p-1 shadow-lg ring-1 ring-black/5"
                     [ngClass]="
                       getActiveTheme()==='dark' ? 'border-gray-700 bg-gray-900' :
                       getActiveTheme()==='light' ? 'border-gray-200 bg-white' :
                       'border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-900'">
                    <button type="button" (click)="setTheme('light')"
                            class="flex w-full items-center gap-2 rounded px-2 py-2 text-left text-sm"
                            [ngClass]="
                              getActiveTheme()==='dark' ? 'text-gray-200 hover:bg-gray-800' :
                              getActiveTheme()==='light' ? 'text-gray-700 hover:bg-gray-100' :
                              'text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800'"
                            [class.bg-gray-100]="isThemeActive('light') && getActiveTheme()!=='dark'"
                            [class.bg-gray-800]="isThemeActive('light') && getActiveTheme()==='dark'"
                            [class.dark:bg-gray-800]="isThemeActive('light') && getActiveTheme()==='system'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4"
                             [ngClass]="getActiveTheme()==='dark' ? 'fill-gray-300' : getActiveTheme()==='system' ? 'fill-gray-500 dark:fill-gray-300' : 'fill-gray-500'" viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm10.45 12.73l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM12 4V1h-1v3h1zm0 19v-3h-1v3h1zm8-8h3v-1h-3v1zM1 12H4v-1H1v1zm15.24-7.16l1.42 1.42 1.79-1.8-1.41-1.41-1.8 1.79zM4.22 18.36l1.8-1.79-1.42-1.42-1.79 1.8 1.41 1.41zM12 6a6 6 0 100 12 6 6 0 000-12z"/></svg>
                        <span class="flex-1">Light</span>
                        <svg *ngIf="isThemeActive('light')" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 fill-emerald-500" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 00-1.414 0L8 12.586 4.707 9.293A1 1 0 003.293 10.707l4 4a1 1 0 001.414 0l8-8a1 1 0 000-1.414z"/></svg>
                    </button>
                    <button type="button" (click)="setTheme('dark')"
                            class="flex w-full items-center gap-2 rounded px-2 py-2 text-left text-sm"
                            [ngClass]="
                              getActiveTheme()==='dark' ? 'text-gray-200 hover:bg-gray-800' :
                              getActiveTheme()==='light' ? 'text-gray-700 hover:bg-gray-100' :
                              'text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800'"
                            [class.bg-gray-100]="isThemeActive('dark') && getActiveTheme()!=='dark' && getActiveTheme()!=='system'"
                            [class.bg-gray-800]="isThemeActive('dark') && getActiveTheme()==='dark'"
                            [class.dark:bg-gray-800]="isThemeActive('dark') && getActiveTheme()==='system'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4"
                             [ngClass]="getActiveTheme()==='dark' ? 'fill-gray-300' : getActiveTheme()==='system' ? 'fill-gray-500 dark:fill-gray-300' : 'fill-gray-500'" viewBox="0 0 24 24"><path d="M12 2a9.93 9.93 0 00-7.07 2.93A10 10 0 1012 2zm0 18a8 8 0 118-8 8 8 0 01-8 8z"/></svg>
                        <span class="flex-1">Dark</span>
                        <svg *ngIf="isThemeActive('dark')" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 fill-emerald-500" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 00-1.414 0L8 12.586 4.707 9.293A1 1 0 003.293 10.707l4 4a1 1 0 001.414 0l8-8a1 1 0 000-1.414z"/></svg>
                    </button>
                    <button type="button" (click)="setTheme('system')"
                            class="flex w-full items-center gap-2 rounded px-2 py-2 text-left text-sm"
                            [ngClass]="
                              getActiveTheme()==='dark' ? 'text-gray-200 hover:bg-gray-800' :
                              getActiveTheme()==='light' ? 'text-gray-700 hover:bg-gray-100' :
                              'text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800'"
                            [class.bg-gray-100]="isThemeActive('system') && getActiveTheme()!=='dark' && getActiveTheme()!=='system'"
                            [class.bg-gray-800]="isThemeActive('system') && getActiveTheme()==='dark'"
                            [class.dark:bg-gray-800]="isThemeActive('system') && getActiveTheme()==='system'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4"
                             [ngClass]="getActiveTheme()==='dark' ? 'fill-gray-300' : getActiveTheme()==='system' ? 'fill-gray-500 dark:fill-gray-300' : 'fill-gray-500'" viewBox="0 0 24 24"><path d="M21 3H3a2 2 0 00-2 2v11a2 2 0 002 2h7l-1 2h6l-1-2h7a2 2 0 002-2V5a2 2 0 00-2-2zm0 13H3V5h18v11z"/></svg>
                        <span class="flex-1">System</span>
                        <svg *ngIf="isThemeActive('system')" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 fill-emerald-500" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 00-1.414 0L8 12.586 4.707 9.293A1 1 0 003.293 10.707l4 4a1 1 0 001.414 0l8-8a1 1 0 000-1.414z"/></svg>
                    </button>
                </div>
            </div>
            </div>
        </div>
        <mat-accordion class="headers-align z-10">
            <!-- Create new layer interface -->
            <mat-expansion-panel #newlayer>
                <mat-expansion-panel-header>
                    <mat-panel-title>Create New Layer</mat-panel-title>
                    <mat-panel-description>Create a new empty layer</mat-panel-description>
                </mat-expansion-panel-header>

                <!-- Domain buttons for latest version -->
                <div class="button-group">
                    <button *ngFor="let domain of latestDomains" mat-raised-button (click)="newLayer(domain.id)">
                        {{ domain.name }}
                    </button>
                </div>

                <!-- More domain/version options -->
                <mat-expansion-panel>
                    <mat-expansion-panel-header>
                        <mat-panel-title>More Options</mat-panel-title>
                    </mat-expansion-panel-header>

                    <div class="multi-column multi-column-container">
                        <div class="md-column">
                            <!-- select a version -->
                            <mat-form-field>
                                <mat-label>Select a version</mat-label>
                                <mat-select [(ngModel)]="nVersion" required>
                                    <mat-option [value]="null">none</mat-option>
                                    <mat-option *ngFor="let nVersion of dataService.versions" [value]="nVersion">
                                        {{ nVersion.name }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <!-- select a domain -->
                            <mat-form-field>
                                <mat-label>Select a domain</mat-label>
                                <mat-select [(ngModel)]="nDomain" [disabled]="!nVersion" required>
                                    <mat-option [value]="null">none</mat-option>
                                    <mat-option *ngFor="let nDomain of filterDomains(nVersion)" [value]="nDomain">
                                        {{ nDomain.name }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <!-- note -->
                            <span class="text-deemphasis">
                                *Note: ATT&CK Versions prior to v{{ minimumSupportedVersion }} are not supported by Navigator v{{ navVersion }}.
                            </span>
                        </div>
                        <div class="or-column">
                            <b>OR</b>
                        </div>
                        <div class="md-column">
                            <!-- bundle URL -->
                            <mat-form-field>
                                <mat-label>Collection or STIX bundle URL</mat-label>
                                <input type="url" matInput [(ngModel)]="loadData.url" />
                            </mat-form-field>
                            <!-- bundle version number -->
                            <mat-form-field>
                                <mat-label>Bundle version number</mat-label>
                                <input type="number" matInput [(ngModel)]="loadData.version" />
                                <mat-hint>ATT&CK version (e.g. 12)</mat-hint>
                            </mat-form-field>
                            <!-- bundle domain identifier -->
                            <mat-form-field>
                                <mat-label>Bundle domain</mat-label>
                                <input type="text" matInput [(ngModel)]="loadData.identifier" />
                                <mat-hint>Domain identifier (e.g. defending-iaas)</mat-hint>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="multi-column multi-column-container">
                        <div class="md-column">
                            <button class="rounded-md bg-white/10 px-3 py-2 text-sm text-white shadow-xs hover:bg-white/20 disabled:opacity-50 disabled:hover:bg-white/10" [disabled]="!nVersion || !nDomain" (click)="newLayer(nDomain.id)">
                                Create layer from version
                            </button>
                        </div>
                        <div class="sm-column"></div>
                        <div class="md-column">
                            <button
 class="rounded-md bg-white/10 px-3 py-2 text-sm text-white shadow-xs hover:bg-white/20 disabled:opacity-50 disabled:hover:bg-white/10"
                                [disabled]="!loadData.url || !loadData.version || !loadData.identifier"
                                (click)="newLayerFromURL(loadData)">
                                Create layer from bundle
                            </button>
                        </div>
                    </div>
                </mat-expansion-panel>
            </mat-expansion-panel>

            <!-- Open existing layer interface -->
            <mat-expansion-panel>
                <mat-expansion-panel-header>
                    <mat-panel-title>Open Existing Layer</mat-panel-title>
                    <mat-panel-description>Load a layer from your computer or a URL</mat-panel-description>
                </mat-expansion-panel-header>

                <div class="multi-column multi-column-container">
                    <div class="md-column">
                        <button mat-raised-button (click)="openUploadPrompt()">Upload from local</button>
                        <input id="uploader" type="file" style="display: none" (change)="loadLayerFromFile()" />
                    </div>
                    <div class="or-column">
                        <b>OR</b>
                    </div>
                    <div class="md-column">
                        <mat-form-field class="hide-subscript">
                            <mat-label>Load from URL</mat-label>
                            <input type="text" matInput [(ngModel)]="loadURL" />
                            <button
                                class="icon-button-scale-down"
                                matSuffix
                                mat-icon-button
                                aria-label="go"
                                [disabled]="!loadURL"
                                (click)="loadLayerFromURL(loadURL, true)">
                                <mat-icon>chevron_right</mat-icon>
                            </button>
                        </mat-form-field>
                    </div>
                </div>
            </mat-expansion-panel>

            <!-- Create layer from other layers -->
            <mat-expansion-panel (opened)="activeTab.showScoreVariables = true" (closed)="activeTab.showScoreVariables = false">
                <mat-expansion-panel-header>
                    <mat-panel-title>Create Layer from Other Layers</mat-panel-title>
                    <mat-panel-description>Select layers to inherit properties from</mat-panel-description>
                </mat-expansion-panel-header>

                <div class="multi-column-container hide-subscript">
                    <!-- domain -->
                    <div class="multi-column">
                        <div class="md-column">
                            <mat-form-field>
                                <mat-label>domain</mat-label>
                                <mat-select [(ngModel)]="opSettings.domain" required>
                                    <mat-option *ngFor="let domain of dataService.domains" [value]="domain.id">
                                        {{ domain.name }} {{ domain.version.name }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="spacer"></div>
                        <div class="lg-column align-center">
                            <span>Select the domain for the new layer. Only layers of the same domain and version can be merged.</span>
                        </div>
                    </div>

                    <!-- score expression -->
                    <div class="multi-column">
                        <div class="md-column">
                            <mat-form-field>
                                <mat-label>score expression</mat-label>
                                <input
                                    type="text"
                                    matInput
                                    [disabled]="!opSettings.domain"
                                    [(ngModel)]="opSettings.scoreExpression"
                                    (keyup)="opSettings.scoreExpression = opSettings.scoreExpression.toLowerCase()"
                                    style="letter-spacing: 2px" />
                                <mat-hint style="color: red" align="start">{{ getScoreExpressionError() }}</mat-hint>
                            </mat-form-field>
                        </div>
                        <div class="spacer"></div>
                        <div class="lg-column align-center" [ngClass]="{ disabled: !opSettings.domain }">
                            <span>
                                Use constants (numbers) and layer variables (yellow, above) to write an expression for the initial value of scores in
                                the new layer. A full list of supported operations can be found
                                <a href="http://mathjs.org/docs/expressions/syntax.html#operators">here</a>
                                . Leave blank to initialize scores to 0. Here's a list of available layer variables:
                                <ul *ngFor="let tab of layerTabs; let $i = index">
                                    <li
                                        *ngIf="
                                            activeTab.showScoreVariables &&
                                            tab.isDataTable &&
                                            (!opSettings.domain || tab.domain === opSettings.domain) &&
                                            isAlphabetical(indexToChar($i))
                                        ">
                                        <span class="tab-enumerator-highlight">{{ indexToChar($i) }}</span>
                                        ({{ tab.isDataTable ? tab.viewModel.name : tab.title }})
                                    </li>
                                </ul>
                            </span>
                        </div>
                    </div>

                    <!-- gradient -->
                    <div class="multi-column">
                        <div class="md-column">
                            <mat-form-field>
                                <mat-label>gradient</mat-label>
                                <mat-select [(ngModel)]="opSettings.gradientVM" [disabled]="!opSettings.domain">
                                    <mat-option [value]="null">none</mat-option>
                                    <mat-option *ngFor="let vm of getFilteredVMs()" [value]="vm">{{ vm.name }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="spacer"></div>
                        <div class="lg-column align-center" [ngClass]="{ disabled: !opSettings.domain }">
                            <span>
                                Select which layer to import the scoring gradient from. Leave blank to initialize with the default scoring gradient.
                            </span>
                        </div>
                    </div>

                    <!-- coloring -->
                    <div class="multi-column">
                        <div class="md-column">
                            <mat-form-field>
                                <mat-label>coloring</mat-label>
                                <mat-select [(ngModel)]="opSettings.coloringVM" [disabled]="!opSettings.domain">
                                    <mat-option [value]="null">none</mat-option>
                                    <mat-option *ngFor="let vm of getFilteredVMs()" [value]="vm">{{ vm.name }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="spacer"></div>
                        <div class="lg-column align-center" [ngClass]="{ disabled: !opSettings.domain }">
                            <span>Select which layer to import manually assigned colors from. Leave blank to initialize with no colors.</span>
                        </div>
                    </div>

                    <!-- comments -->
                    <div class="multi-column">
                        <div class="md-column">
                            <mat-form-field>
                                <mat-label>comments</mat-label>
                                <mat-select [(ngModel)]="opSettings.commentVM" [disabled]="!opSettings.domain">
                                    <mat-option [value]="null">none</mat-option>
                                    <mat-option *ngFor="let vm of getFilteredVMs()" [value]="vm">{{ vm.name }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="spacer"></div>
                        <div class="lg-column align-center" [ngClass]="{ disabled: !opSettings.domain }">
                            <span>Select which layer to import comments from. Leave blank to initialize with no comments.</span>
                        </div>
                    </div>

                    <!-- links -->
                    <div class="multi-column">
                        <div class="md-column">
                            <mat-form-field>
                                <mat-label>links</mat-label>
                                <mat-select [(ngModel)]="opSettings.linkVM" [disabled]="!opSettings.domain">
                                    <mat-option [value]="null">none</mat-option>
                                    <mat-option *ngFor="let vm of getFilteredVMs()" [value]="vm">{{ vm.name }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="spacer"></div>
                        <div class="lg-column align-center" [ngClass]="{ disabled: !opSettings.domain }">
                            <span>Select which layer to import technique links from. Leave blank to initialize without links.</span>
                        </div>
                    </div>

                    <!-- metadata -->
                    <div class="multi-column">
                        <div class="md-column">
                            <mat-form-field>
                                <mat-label>metadata</mat-label>
                                <mat-select [(ngModel)]="opSettings.metadataVM" [disabled]="!opSettings.domain">
                                    <mat-option [value]="null">none</mat-option>
                                    <mat-option *ngFor="let vm of getFilteredVMs()" [value]="vm">{{ vm.name }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="spacer"></div>
                        <div class="lg-column align-center" [ngClass]="{ disabled: !opSettings.domain }">
                            <span>Select which layer to import technique metadata from. Leave blank to initialize without metadata.</span>
                        </div>
                    </div>

                    <!-- enabled state -->
                    <div class="multi-column">
                        <div class="md-column">
                            <mat-form-field>
                                <mat-label>states</mat-label>
                                <mat-select [(ngModel)]="opSettings.enabledVM" [disabled]="!opSettings.domain">
                                    <mat-option [value]="null">none</mat-option>
                                    <mat-option *ngFor="let vm of getFilteredVMs()" [value]="vm">{{ vm.name }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="spacer"></div>
                        <div class="lg-column align-center" [ngClass]="{ disabled: !opSettings.domain }">
                            <span>Select which layer to import enabled/disabled states from. Leave blank to initialize all to enabled.</span>
                        </div>
                    </div>

                    <!-- filters -->
                    <div class="multi-column">
                        <div class="md-column">
                            <mat-form-field>
                                <mat-label>filters</mat-label>
                                <mat-select [(ngModel)]="opSettings.filterVM" [disabled]="!opSettings.domain">
                                    <mat-option [value]="null">none</mat-option>
                                    <mat-option *ngFor="let vm of getFilteredVMs()" [value]="vm">{{ vm.name }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="spacer"></div>
                        <div class="lg-column align-center" [ngClass]="{ disabled: !opSettings.domain }">
                            <span>Select which layer to import filters from. Leave blank to initialize with no filters.</span>
                        </div>
                    </div>

                    <!-- legend -->
                    <div class="multi-column">
                        <div class="md-column">
                            <mat-form-field>
                                <mat-label>legend</mat-label>
                                <mat-select [(ngModel)]="opSettings.legendVM" [disabled]="!opSettings.domain">
                                    <mat-option [value]="null">none</mat-option>
                                    <mat-option *ngFor="let vm of getFilteredVMs()" [value]="vm">{{ vm.name }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="spacer"></div>
                        <div class="lg-column align-center" [ngClass]="{ disabled: !opSettings.domain }">
                            <span>Select which layer to import the legend from. Leave blank to initialize with an empty legend.</span>
                        </div>
                    </div>

                    <!-- create -->
                    <div style="margin-top: 16px;">
                        <button mat-flat-button
                            [disabled]="getScoreExpressionError() || !opSettings.domain"
                            (click)="layerByOperation(); showScoreVariables = false">
                            Create layer
                        </button>
                    </div>
                </div>
            </mat-expansion-panel>

            <!-- Customized Navigator-->
            <mat-expansion-panel>
                <mat-expansion-panel-header>
                    <mat-panel-title>Create Customized Navigator</mat-panel-title>
                    <mat-panel-description>Create a hyperlink to a customized ATT&CK Navigator</mat-panel-description>
                </mat-expansion-panel-header>

                <div class="multi-column-container">
                    <div class="section">
                        <!-- default layers-->
                        <h2>Default Layers</h2>
                        <div class="multi-column left-align">
                            <div class="md-column">
                                <ul class="layer-links">
                                    <li *ngFor="let layerLinkURL of layerLinkURLs; let i = index; trackBy: trackByFunction">
                                        <mat-form-field>
                                            <mat-label>default layer {{i+1}}</mat-label>
                                            <input type="text" matInput [(ngModel)]="layerLinkURLs[i]" />
                                            <button class="icon-button-scale-down" matSuffix mat-icon-button aria-label="remove" (click)="removeLayerLink(i)">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </mat-form-field>
                                    </li>
                                    <li>
                                        <button mat-raised-button (click)="addLayerLink()">
                                            add {{ layerLinkURLs.length > 0 ? 'another' : 'a' }} default layer
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            <div class="spacer"></div>
                            <div class="lg-column">
                                <span>Enter the URLs of layers hosted on the web. The custom navigator will open these layers by default.</span>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <!-- navigator features -->
                        <h2>Navigator Features</h2>
                        <ng-container *ngFor="let feature of configService.customizefeatureList">
                            <div *ngIf="!feature.subfeatures" class="feature-row multi-column left-align">
                                <div class="md-column align-center">
                                    <mat-checkbox class="adaptive-checkbox" [(ngModel)]="feature.enabled">
                                        {{ feature.name.split('_').join(' ') }}
                                    </mat-checkbox>
                                </div>
                                <div class="spacer"></div>
                                <div class="lg-column">
                                    <span>{{ feature.description }}</span>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>

                <!-- Custom Navigator URL -->
                <div style="text-align: center">
                    <mat-form-field id="layerlinkfield">
                        <mat-label>custom navigator url</mat-label>
                        <input
                            id="layerLink"
                            type="text"
                            matInput
                            (click)="selectLayerLink()"
                            [value]="getLayerLink()"
                            readonly />
                        <button class="icon-button-scale-down" (click)="copyLayerLink()" matSuffix mat-icon-button aria-label="copy" matTooltip="copy">
                            <mat-icon>content_copy</mat-icon>
                        </button>
                        <mat-hint *ngIf="copiedRecently">copied</mat-hint>
                    </mat-form-field>
                </div>
            </mat-expansion-panel>
        </mat-accordion>
    </div>
</ng-template>

<!-- data table tab template -->
<ng-template [ngIf]="activeTab && activeTab.isDataTable">
    <DataTable
        [viewModel]="activeTab.viewModel"
        [currentDropdown]="dropdownEnabled"
        (dropdownChange)="dropdownEnabled = $event"
        (onScroll)="adjustHeader($event)"></DataTable>
</ng-template>
